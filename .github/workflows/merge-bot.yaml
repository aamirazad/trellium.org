name: Merge Bot

on:
  issue_comment:
    types: [created]

jobs:
  merge-and-update:
    if: github.event.issue.pull_request != null && contains(github.event.comment.body, '/merge')
    runs-on: ubuntu-latest
    steps:
      - name: Create loading comment
        id: loading_comment
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.issue.number }}
          body: |
            <img src="https://xrgkyc5aexvkc7oh.public.blob.vercel-storage.com/loading-spinner-TPIqYiHmChtY21ZfF6puFEZq9X5MDx" width="20" align="top">  Merging...

            _I'm going as fast as I can!_
            
            [View workflow logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

      - name: Set commenter info
        run: |
          echo "COMMENTER=${{ github.event.comment.user.login }}" >> $GITHUB_ENV
          echo "PR_NUMBER=${{ github.event.issue.number }}" >> $GITHUB_ENV

      - name: Check permissions
        id: check_permissions
        uses: octokit/request-action@v2.x
        with:
          route: GET /repos/${{ github.repository }}/collaborators/${{ env.COMMENTER }}/permission
        env:
          GITHUB_TOKEN: ${{ secrets.MERGE_PAT }}

      - name: Verify maintainer permission
        id: permission_check
        run: |
          PERMISSION=$(jq -r .permission <<< '${{ steps.check_permissions.outputs.data }}')
          if [[ "$PERMISSION" == "admin" || "$PERMISSION" == "write" ]]; then
            echo "allowed=true" >> $GITHUB_OUTPUT
          else
            echo "allowed=false" >> $GITHUB_OUTPUT
          fi

      - name: Comment permission denied
        if: steps.permission_check.outputs.allowed == 'false'
        uses: peter-evans/create-or-update-comment@v4
        with:
          comment-id: ${{ steps.loading_comment.outputs.comment-id }}
          edit-mode: replace
          body: |
            🔒 Sorry @${{ env.COMMENTER }}, only repository maintainers can use the `/merge` command.
            
            [View workflow logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

      - name: Checkout repo
        if: steps.permission_check.outputs.allowed == 'true'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.MERGE_PAT }}

      - name: Get PR details
        if: steps.permission_check.outputs.allowed == 'true'
        id: pr
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.MERGE_PAT }}
          script: |
            const { data } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: ${{ github.event.issue.number }}
            });

            core.setOutput('branch', data.head.ref);
            core.setOutput('base_branch', data.base.ref);
            core.setOutput('title', data.title);
            core.setOutput('author', data.user.login);
            core.setOutput('mergeable', data.mergeable);
            core.setOutput('state', data.state);

      - name: Fetch all branches
        if: steps.permission_check.outputs.allowed == 'true'
        run: git fetch origin +refs/heads/*:refs/remotes/origin/*

      - name: Check if PR is up to date
        if: steps.permission_check.outputs.allowed == 'true'
        id: up_to_date
        run: |
          git checkout ${{ steps.pr.outputs.branch }}
          git fetch origin ${{ steps.pr.outputs.base_branch }}
          if git merge-base --is-ancestor origin/${{ steps.pr.outputs.base_branch }} ${{ steps.pr.outputs.branch }}; then
            echo "result=up_to_date" >> $GITHUB_OUTPUT
          else
            echo "result=outdated" >> $GITHUB_OUTPUT
          fi

      - name: Comment if outdated
        if: steps.permission_check.outputs.allowed == 'true' && steps.up_to_date.outputs.result == 'outdated'
        uses: peter-evans/create-or-update-comment@v4
        with:
          comment-id: ${{ steps.loading_comment.outputs.comment-id }}
          edit-mode: replace
          body: |
            ⚠️ Cannot fast-forward merge because `${{ steps.pr.outputs.branch }}` is not up to date with `${{ steps.pr.outputs.base_branch }}`. Please rebase first.
            
            [View workflow logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

      - name: Fast-forward merge into base
        if: steps.permission_check.outputs.allowed == 'true' && steps.up_to_date.outputs.result == 'up_to_date'
        id: merge
        run: |
          git checkout ${{ steps.pr.outputs.base_branch }}
          PREV_SHA=$(git rev-parse HEAD)
          echo "prev_sha=$PREV_SHA" >> $GITHUB_OUTPUT

          if git merge --ff-only origin/${{ steps.pr.outputs.branch }}; then
            NEW_SHA=$(git rev-parse HEAD)
            echo "new_sha=$NEW_SHA" >> $GITHUB_OUTPUT
            
            if git push origin ${{ steps.pr.outputs.base_branch }}; then
              echo "success=true" >> $GITHUB_OUTPUT
            else
              echo "success=false" >> $GITHUB_OUTPUT
              echo "error_type=push_failed" >> $GITHUB_OUTPUT
            fi
          else
            echo "success=false" >> $GITHUB_OUTPUT
            echo "error_type=merge_failed" >> $GITHUB_OUTPUT
          fi

      - name: Comment merge failure
        if: steps.permission_check.outputs.allowed == 'true' && steps.up_to_date.outputs.result == 'up_to_date' && steps.merge.outputs.success == 'false'
        uses: peter-evans/create-or-update-comment@v4
        with:
          comment-id: ${{ steps.loading_comment.outputs.comment-id }}
          edit-mode: replace
          body: |
            ❌ Merge failed.

            ${{ steps.merge.outputs.error_type == 'push_failed' && '**Push rejected**: This is likely due to repository rules (e.g., no merge commits allowed). The merge was successful locally but could not be pushed to the remote repository.' || '**Fast-forward merge failed**: This usually means there are conflicts or the branch cannot be fast-forwarded. Please check the branch status and try rebasing.' }}

            [View workflow logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

            _@${{ env.COMMENTER }}_

      - name: Set additional environment variables for changelog
        if: steps.permission_check.outputs.allowed == 'true' && steps.merge.outputs.success == 'true'
        run: |
          echo "PR_TITLE=${{ steps.pr.outputs.title }}" >> $GITHUB_ENV
          echo "PR_AUTHOR=${{ steps.pr.outputs.author }}" >> $GITHUB_ENV
          echo "PR_BRANCH=${{ steps.pr.outputs.branch }}" >> $GITHUB_ENV
          echo "BASE_BRANCH=${{ steps.pr.outputs.base_branch }}" >> $GITHUB_ENV
          echo "PREV_SHA=${{ steps.merge.outputs.prev_sha }}" >> $GITHUB_ENV
          echo "NEW_SHA=${{ steps.merge.outputs.new_sha }}" >> $GITHUB_ENV

      - name: Update CHANGELOG.md
        if: steps.permission_check.outputs.allowed == 'true' && steps.merge.outputs.success == 'true'
        id: changelog
        run: |
          declare -A TYPE_MAP=(
            ["build"]="Build"
            ["ci"]="CI"
            ["docs"]="Documentation"
            ["feat"]="Feature"
            ["fix"]="Fix"
            ["perf"]="Performance"
            ["refactor"]="Refactor"
            ["style"]="Style"
            ["test"]="Test"
          )

          # Parse type, scope, and description from PR_TITLE
          TYPE=$(echo "$PR_TITLE" | sed -E 's/^([a-z]+)(\([^\)]*\))?:.*/\1/')
          SCOPE=$(echo "$PR_TITLE" | sed -nE 's/^[a-z]+\(([^)]*)\):.*/\1/p')
          DESCRIPTION=$(echo "$PR_TITLE" | sed -E 's/^[a-z]+(\([^\)]*\))?:\s*(.*)/\2/')
          TYPE_HUMAN="${TYPE_MAP[$TYPE]}"

          if [[ -n "$TYPE_HUMAN" ]]; then
            if [[ -n "$SCOPE" ]]; then
              PREFIX="**${TYPE_HUMAN}**(${SCOPE})"
            else
              PREFIX="**${TYPE_HUMAN}**"
            fi
          else
            PREFIX="**Other**"
          fi

          SHORT_PREV=$(echo $PREV_SHA | cut -c1-7)
          SHORT_NEW=$(echo $NEW_SHA | cut -c1-7)
          COMPARE_URL="https://github.com/${{ github.repository }}/compare/$SHORT_PREV...$SHORT_NEW"

          ENTRY="- ${PREFIX}: ${DESCRIPTION} ([#${PR_NUMBER}](https://github.com/${{ github.repository }}/pull/${PR_NUMBER})) by [@${PR_AUTHOR}](https://github.com/${PR_AUTHOR}) - [\`${SHORT_PREV}...${SHORT_NEW}\`]($COMPARE_URL)"

          # If no "Unreleased Features" section, prepend it with details block
          if ! grep -q '^## Unreleased Features' CHANGELOG.md; then
            cat <<EOF > tmp_changelog.md
          ## Unreleased Features

          <details>
          <summary>All commits</summary>

          $ENTRY

          </details>

          EOF
            cat CHANGELOG.md >> tmp_changelog.md
            mv tmp_changelog.md CHANGELOG.md
          else
            # Insert the new entry as the first item after the blank line following summary
            awk -v entry="$ENTRY" 'BEGIN{done=0; after_summary=0}
            {
              if(!done && /<summary>All commits<\/summary>/){
                print
                after_summary=1
                next
              }
              if(after_summary && !done && /^$/) {
                print
                print entry
                done=1
                next
              }
              print
            }' CHANGELOG.md > tmp_changelog.md
            mv tmp_changelog.md CHANGELOG.md
          fi

          git config user.name "${COMMENTER}"
          git config user.email "${COMMENTER}@users.noreply.github.com"

          git add CHANGELOG.md
          if git commit --author "${PR_AUTHOR} <${PR_AUTHOR}@users.noreply.github.com>" -m "chore(docs): update changelog for #${PR_NUMBER}"; then
            if git push origin $BASE_BRANCH; then
              echo "success=true" >> $GITHUB_OUTPUT
            else
              echo "success=false" >> $GITHUB_OUTPUT
              echo "error=push_failed" >> $GITHUB_OUTPUT
            fi
          else
            echo "success=false" >> $GITHUB_OUTPUT
            echo "error=commit_failed" >> $GITHUB_OUTPUT
          fi

      - name: Comment changelog failure
        if: steps.permission_check.outputs.allowed == 'true' && steps.merge.outputs.success == 'true' && steps.changelog.outputs.success == 'false'
        uses: peter-evans/create-or-update-comment@v4
        with:
          comment-id: ${{ steps.loading_comment.outputs.comment-id }}
          edit-mode: replace
          body: |
            ⚠️ Merge succeeded but changelog update failed.
            
            **Error**: ${{ steps.changelog.outputs.error == 'push_failed' && 'Failed to push changelog commit' || 'Failed to create changelog commit' }}
            
            The PR has been merged successfully but the changelog was not updated automatically.
            
            [View workflow logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            
            _@${{ env.COMMENTER }}_

      - name: Comment success
        if: steps.permission_check.outputs.allowed == 'true' && steps.merge.outputs.success == 'true' && steps.changelog.outputs.success == 'true'
        uses: peter-evans/create-or-update-comment@v4
        with:
          comment-id: ${{ steps.loading_comment.outputs.comment-id }}
          edit-mode: replace
          body: |
            🎉 Successfully fast-forward merged `${{ env.PR_BRANCH }}` into `${{ env.BASE_BRANCH }}`.
            - Compare: https://github.com/${{ github.repository }}/compare/${{ env.PREV_SHA }}...${{ env.NEW_SHA }}
            
            [View workflow logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
